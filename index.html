<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Neonate Dosage Calculator</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="DosageCalc">
  <meta name="theme-color" content="#2a9d8f">
  <link rel="manifest" href="/neonate/manifest.json">
  <link rel="apple-touch-icon" sizes="180x180" href="/neonate/icon-180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/neonate/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/neonate/icon-512.png">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #2a9d8f;
      --header: #1d3557;
      --bg: #f0f4f8;
      --card: #ffffff;
      --border: #dcdcdc;
      --shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    * { box-sizing: border-box; font-family: 'Inter', sans-serif; margin: 0; padding: 0; }
    body { margin: 0; padding: 1.5rem; background-color: var(--bg); color: var(--header); font-size: 1rem; }
    h1 { text-align: center; font-weight: 600; font-size: 1.75rem; margin-bottom: 1.5rem; }
    .container { background: var(--card); max-width: 600px; margin: auto; border-radius: 16px; padding: 1.5rem; box-shadow: var(--shadow); transition: transform 0.3s ease, box-shadow 0.3s ease; }
    .container:hover { transform: translateY(-5px); box-shadow: 0 6px 18px rgba(0,0,0,0.12); }
    .form-group { margin-bottom: 1rem; display: none; }
    .form-group.active { display: block; }
    label { font-weight: 500; display: block; margin-bottom: 0.25rem; }
    input[type="number"] { width: 100%; padding: 0.6rem; font-size: 16px; border: 1px solid var(--border); border-radius: 12px; background-color: #fff; transition: border-color 0.3s ease, box-shadow 0.3s ease; }
    input[type="number"]:focus { border-color: var(--primary); box-shadow: 0 0 8px rgba(42, 157, 143, 0.3); }
    .radio-group { display: flex; gap: 1rem; margin-top: 0.5rem; }
    .radio-group label { font-weight: 400; }
    .btn { width: 100%; padding: 0.75rem; background-color: var(--primary); color: white; font-size: 1rem; font-weight: 500; border: none; border-radius: 12px; cursor: pointer; margin: 1rem 0; transition: background-color 0.3s ease; }
    .btn:hover { background-color: #21867a; }
    .tabs { display: flex; gap: 0.5rem; flex-wrap: wrap; justify-content: center; margin-bottom: 1.5rem; position: sticky; top: 0; background: var(--card); padding: 1rem 0; z-index: 10; border-bottom: 1px solid var(--border); }
    .tab-button { padding: 0.5rem 1rem; background-color: #fff; border: 1px solid var(--border); border-radius: 12px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; }
    .tab-button:hover, .tab-button.active { background-color: var(--primary); color: white; border-color: var(--primary); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .section-title { margin-top: 2rem; font-weight: 600; font-size: 1.1rem; color: var(--header); }
    .note { color: #888; font-size: 0.875rem; margin-top: 0.5rem; }
    .chart-image { width: 100%; height: auto; border-radius: 12px; margin-top: 1rem; border: 1px solid var(--border); }
    .title { font-weight: 600; margin-bottom: 6px; margin-top: 1rem; color: var(--header); }
    .canvas-wrap { position: relative; overflow: hidden; background: #f7f9fb; border: 1px solid var(--border); margin-bottom: 1rem; width: 100%; }
    .canvas-wrap img { display: block; width: 100%; height: auto; }
    .plot { position: absolute; pointer-events: none; background: transparent; z-index: 5; }
    .crosshair-x { position: absolute; height: 1px; background: red !important; left: 0; right: 0; display: block !important; opacity: 1 !important; z-index: 15; cursor: row-resize; touch-action: none; will-change: transform; }
    .crosshair-y { position: absolute; width: 1px; background: red !important; top: 0; bottom: 0; display: block !important; opacity: 1 !important; z-index: 15; cursor: col-resize; touch-action: none; will-change: transform; }
    .crosshair-x::before, .crosshair-y::before { content: ''; position: absolute; pointer-events: auto; }
    .crosshair-x::before { width: 100%; height: 20px; top: -10px; left: 0; }
    .crosshair-y::before { height: 100%; width: 20px; left: -10px; top: 0; }
    .readout { position: absolute; right: 8px; bottom: 8px; background: rgba(13,19,32,0.85); border: 1px solid #243147; border-radius: 10px; padding: 8px 10px; font-size: 12px; color: white; z-index: 20; }
    .inputs { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem; }
    .inputs label { flex-basis: 100%; margin-bottom: 0; }
    .inputs input { flex: 1; min-width: 100px; }
    .inputs button { flex: 1; min-width: 100px; margin: 0; }
    @media (max-width: 600px) {
      body { font-size: 0.95rem; padding: 0; }
      .container { max-width: 100%; padding: 0; border-radius: 0; }
      .tabs { padding: 0.5rem; }
      .radio-group { flex-direction: column; }
      .tab-button { font-size: 0.95rem; }
      .inputs { flex-direction: column; }
      .inputs input, .inputs button { width: 100%; }
      .canvas-wrap { margin-left: 0; margin-right: 0; padding: 0; border-left: none; border-right: none; border-radius: 0; }
      .title, .inputs, .form-group, .section-title { padding: 0 1rem; }
      .table-wrapper { padding: 0 2px; font-size: 0.95rem; }
      th, td { font-size: 0.9rem; padding: 6px 4px; }
      .crosshair-x::before { height: 30px; top: -15px; }
      .crosshair-y::before { width: 30px; left: -15px; }
    }
    .table-wrapper { overflow-x: auto; background: var(--card); border-radius: 8px; box-shadow: var(--shadow); padding: 0 2px; margin: 0 auto 1rem; display: block; width: fit-content; max-width: 100%; font-size: 0.95rem; }
    table { border-collapse: collapse; width: 100%; }
    th, td { padding: 6px 8px; text-align: left; font-size: 1rem; border-bottom: 1px solid var(--border); white-space: nowrap; vertical-align: top; }
    th { background: #f7f9fb; font-weight: 600; position: sticky; top: 0; }
    tr:last-child td { border-bottom: none; }
    .cell-content { display: flex; flex-direction: column; justify-content: flex-start; }
    .conc { font-size: 0.75rem; color: gray; }
  </style>
</head>
<body>
  <h1>Neonate Dosage Calculator</h1>
  <div class="container">
    <div class="tabs">
      <button class="tab-button active" onclick="openTab('phototherapy')">Phototherapy</button>
      <button class="tab-button" onclick="openTab('dosage')">Dosage</button>
      <button class="tab-button" onclick="openTab('nutrition')">Nutrition</button>
      <button class="tab-button" onclick="openTab('fenton')">Fenton Chart</button>
    </div>

    <!-- PHOTOTHERAPY TAB -->
    <div id="phototherapy" class="tab-content active">
      <div class="inputs form-group active">
        <label>Age (hours):</label>
        <input type="number" id="photo-age-input" step="0.1" min="0" placeholder="Enter age" aria-label="Age in hours">
        <label>TSB (mg/dL):</label>
        <input type="number" id="photo-tsb-input" step="0.1" min="0" placeholder="Enter TSB" aria-label="Total Serum Bilirubin in mg/dL">
        <button class="btn" onclick="setAllCrosshairs()">Set</button>
      </div>

      <div class="title">Phototherapy — No Risk Factors</div>
      <div class="chart" data-xmin="-5.3" data-xmax="342" data-ymin="5.4" data-ymax="24" data-l="9.1" data-t="8.5" data-r="10.8" data-b="21.3">
        <div class="canvas-wrap">
          <img src="https://raw.githubusercontent.com/nuhadwrk/neonate/main/TSB%20levels%20for%20PT%20%26%20ET%201.png" alt="Phototherapy No Risk Factors Chart">
          <div class="plot"><div class="crosshair-x"></div><div class="crosshair-y"></div></div>
          <div class="readout">Age: 0 h (0 d) • TSB: 0 mg/dL (0 µmol/L)</div>
        </div>
      </div>

      <div class="title">Phototherapy — With Risk Factors</div>
      <div class="chart" data-xmin="-5.3" data-xmax="342" data-ymin="3.4" data-ymax="20" data-l="9.1" data-t="8.5" data-r="11.5" data-b="22.2">
        <div class="canvas-wrap">
          <img src="https://raw.githubusercontent.com/nuhadwrk/neonate/main/TSB%20levels%20for%20PT%20%26%20ET%202.png" alt="Phototherapy With Risk Factors Chart">
          <div class="plot"><div class="crosshair-x"></div><div class="crosshair-y"></div></div>
          <div class="readout">Age: 0 h (0 d) • TSB: 0 mg/dL (0 µmol/L)</div>
        </div>
      </div>

      <div class="title">Exchange — No Risk Factors</div>
      <div class="chart" data-xmin="-5" data-xmax="342" data-ymin="13.5" data-ymax="28" data-l="9.2" data-t="8.0" data-r="10.5" data-b="20.2">
        <div class="canvas-wrap">
          <img src="https://raw.githubusercontent.com/nuhadwrk/neonate/main/TSB%20levels%20for%20PT%20%26%20ET%203.png" alt="Exchange No Risk Factors Chart">
          <div class="plot"><div class="crosshair-x"></div><div class="crosshair-y"></div></div>
          <div class="readout">Age: 0 h (0 d) • TSB: 0 mg/dL (0 µmol/L)</div>
        </div>
      </div>

      <div class="title">Exchange — With Risk Factors</div>
      <div class="chart" data-xmin="-5" data-xmax="342" data-ymin="11.5" data-ymax="24" data-l="8.9" data-t="7.2" data-r="10.4" data-b="21.2">
        <div class="canvas-wrap">
          <img src="https://raw.githubusercontent.com/nuhadwrk/neonate/main/TSB%20levels%20for%20PT%20%26%20ET%204.png" alt="Exchange With Risk Factors Chart">
          <div class="plot"><div class="crosshair-x"></div><div class="crosshair-y"></div></div>
          <div class="readout">Age: 0 h (0 d) • TSB: 0 mg/dL (0 µmol/L)</div>
        </div>
      </div>

      <div class="title">Phototherapy Guidelines</div>
      <div class="chart" id="chart-pt" data-xmin="-9.2" data-xmax="175" data-ymin="-0.77" data-ymax="25" data-l="7" data-t="1" data-r="9" data-b="32">
        <div class="canvas-wrap">
          <img src="https://raw.githubusercontent.com/nuhadwrk/neonate/main/PT.jpg" alt="Phototherapy Guidelines">
          <div class="plot"><div class="crosshair-x"></div><div class="crosshair-y"></div></div>
          <div class="readout">Age: 0 h (0 d) • TSB: 0 mg/dL (0 µmol/L)</div>
        </div>
      </div>

      <div class="title">Exchange Transfusion Guidelines</div>
      <div class="chart" id="chart-et" data-xmin="-8.1" data-xmax="175" data-ymin="9.55" data-ymax="25" data-l="7" data-t="16" data-r="10" data-b="37">
        <div class="canvas-wrap">
          <img src="https://raw.githubusercontent.com/nuhadwrk/neonate/main/ET.jpg" alt="Exchange Transfusion Guidelines">
          <div class="plot"><div class="crosshair-x"></div><div class="crosshair-y"></div></div>
          <div class="readout">Age: 0 h (0 d) • TSB: 0 mg/dL (0 µmol/L)</div>
        </div>
      </div>
    </div>

    <!-- DOSAGE TAB -->
    <div id="dosage" class="tab-content">
      <div class="form-group active">
        <label for="weight">Weight (kg):</label>
        <input type="number" id="weight" placeholder="Enter weight" step="0.01" min="0.1">
      </div>
      <div class="form-group active">
        <label>Postnatal Age:</label>
        <div class="radio-group">
          <label><input type="radio" name="age" value="≤ 7 days" checked> ≤ 7 days</label>
          <label><input type="radio" name="age" value="> 7 days"> > 7 days</label>
        </div>
      </div>
      <button class="btn" onclick="updateDosages()">Calculate</button>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Drug</th>
              <th>Mg/Kg/Dose</th>
              <th>Mg/Dose</th>
              <th>(hr)</th>
            </tr>
          </thead>
          <tbody id="dosage-table">
            <tr>
              <td colspan="4">Enter weight to calculate...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- NUTRITION TAB -->
    <div id="nutrition" class="tab-content">
      <div class="form-group active">
        <label for="birth-weight-wl">Birth Weight (kg):</label>
        <input type="number" id="birth-weight-wl" placeholder="Enter birth weight in kg" step="0.01" min="0.1">
      </div>
      <div class="form-group active">
        <label for="current-weight-wl">Current Weight (kg):</label>
        <input type="number" id="current-weight-wl" placeholder="Enter current weight in kg" step="0.01" min="0.1">
      </div>
      <button class="btn" onclick="calculateWeightLoss()">Calculate Weight Loss</button>
      <div id="weight-loss-result" class="note" style="margin-top: 1rem;"></div>

      <div class="form-group active">
        <label for="feed-weight">Weight (kg):</label>
        <input type="number" id="feed-weight" placeholder="Enter weight in kg" step="0.01" min="0.1">
      </div>
      <div class="form-group active">
        <label for="feed-kcal">Target kcal/kg/day:</label>
        <input type="number" id="feed-kcal" placeholder="Enter kcal/kg/day" step="1" min="50">
      </div>
      <div class="form-group active">
        <label>Feed Type:</label>
        <div class="radio-group">
          <label><input type="radio" name="feed-type" value="0.67" checked> Breast Milk (0.67 kcal/ml)</label>
          <label><input type="radio" name="feed-type" value="0.81"> Preterm Formula (0.81 kcal/ml)</label>
        </div>
      </div>
      <button class="btn" onclick="calculateFeedVolume()">Calculate Feed Volume</button>
      <div id="feed-result" class="note" style="margin-top: 1rem;"></div>

      <h3 class="section-title">Nutrition Guidelines</h3>
      <ul>
        <li>Day 1: Term: 60–80 ml/kg/day; Preterm: 80–100 ml/kg/day (D10%)</li>
        <li>Day 2: Term: 80–100 ml/kg/day; Preterm: 100–120 ml/kg/day</li>
        <li>Day 3: Term: 100–120 ml/kg/day (N/5 D10%); Preterm: 120–150 ml/kg/day</li>
        <li>Day 4+: Term: 120–150 ml/kg/day; Preterm: 130–160 ml/kg/day</li>
      </ul>
      <div class="note">Note: Adjust based on clinical assessment.</div>
    </div>
<!-- FENTON TAB -->
<div id="fenton" class="tab-content">
  <div class="form-group active">
    <label for="fenton-weight">Birth Weight (g):</label>
    <input type="number" id="fenton-weight" placeholder="Enter weight in grams" step="1" min="300" max="6000">
  </div>
  <div class="form-group active">
    <label>Sex:</label>
    <div class="radio-group">
      <label><input type="radio" name="sex" value="male" checked> Male</label>
      <label><input type="radio" name="sex" value="female"> Female</label>
    </div>
  </div>
  <div class="form-group active">
    <label for="gestational-age">Gestational Age (weeks):</label>
    <input type="number" id="gestational-age" placeholder="Enter gestational age" step="1" min="22" max="50">
  </div>
  <button class="btn" onclick="updateFenton()">Calculate</button>
  <div id="fenton-result" class="note" style="margin-top: 1rem; padding: 1rem; background: #f7f9fb; border-radius: 8px;"></div>
  
  <!-- FIXED: Public URLs from GitHub -->
  <img src="https://raw.githubusercontent.com/nuhadwrk/neonate/main/FM.jpg" alt="Fenton Chart for Boys" class="chart-image" id="fenton-male" style="display: none;">
  <img src="https://raw.githubusercontent.com/nuhadwrk/neonate/main/FF.jpg" alt="Fenton Chart for Girls" class="chart-image" id="fenton-female" style="display: none;">
  
  <div class="note" style="margin-top: 1rem; text-align: center;">Fenton Growth Charts (2025)</div>
</div>

  <script>
    // Drug database
    const drugData = [
      { name: "Ampicillin", dose: [ { condition: "Standard", mgPerKg: 50, interval: { "≤ 7 days": 12, "> 7 days": 8 } }, { condition: "Meningitis", mgPerKg: 100, interval: { "≤ 7 days": 12, "> 7 days": 8 } } ] },
      { name: "Amikacin", dose: [ { condition: "Standard", mgPerKg: 15, interval: { "≤ 7 days": { "< 2 kg": 48, "> 2 kg": 24 }, "> 7 days": { "< 2 kg": "24–48", "> 2 kg": "12–24" } } } ] },
      { name: "Cefotaxime", dose: [ { condition: "Standard/Meningitis", mgPerKg: 50, interval: { "≤ 7 days": 12, "> 7 days": 8 } } ] },
      { name: "Ceftazidime", dose: [ { condition: "Standard/Meningitis", mgPerKg: 50, interval: { "≤ 7 days": 12, "> 7 days": 8 } } ] },
      { name: "Meropenem", dose: [ { condition: "Standard", mgPerKg: 20, interval: { "≤ 7 days": 12, "> 7 days": 8 } }, { condition: "Meningitis", mgPerKg: 40, interval: { "≤ 7 days": 12, "> 7 days": 8 } } ] },
      { name: "Metronidazole", dose: [ { condition: "Standard", mgPerKg: 7.5, interval: { "≤ 7 days": { "< 1.2 kg": 48, "1.2–2 kg": 24, "> 2 kg": 12 }, "> 7 days": { "< 1.2 kg": 24, "1.2–2 kg": 12, "> 2 kg": 12 } } }, { condition: "Standard (> 2 kg, > 7 days)", mgPerKg: 15, interval: { "> 7 days": { "> 2 kg": 12 } } } ] },
      { name: "PipTaz", dose: [ { condition: "Standard", mgPerKg: 90, interval: { "≤ 7 days": 12, "> 7 days": 8 } } ] },
      { name: "Vancomycin", dose: [ { condition: "Standard", mgPerKg: 15, interval: { "≤ 7 days": { "< 1.2 kg": 24, "1.2–2 kg": "12–18", "> 2 kg": 12 }, "> 7 days": { "< 1.2 kg": 24, "1.2–2 kg": 12, "> 2 kg": 8 } } } ] },
      { name: "Fluconazole", dose: [ { condition: "Loading", mgPerKg: 12, interval: "once" }, { condition: "Maintenance (0–14 days)", mgPerKg: 6, interval: 72 }, { condition: "Maintenance (>14 days)", mgPerKg: 6, interval: 48 } ] },
      { name: "Fluconazole (Prophylaxis)", dose: [ { condition: "Standard (3–6 mg/kg)", mgPerKg: 3, interval: 72 } ] },
      { name: "Caffeine", dose: [ { condition: "Standard", mgPerKg: 5, interval: { "≤ 7 days": 24, "> 7 days": 24 } } ] }
    ];

    // Fenton percentiles
    const fentonPercentiles = {
      male: {
        22: { p10: 400, p90: 600 }, 24: { p10: 500, p90: 750 }, 26: { p10: 600, p90: 900 }, 28: { p10: 800, p90: 1200 },
        30: { p10: 1000, p90: 1500 }, 32: { p10: 1300, p90: 1900 }, 34: { p10: 1700, p90: 2500 }, 36: { p10: 2100, p90: 3100 },
        38: { p10: 2500, p90: 3700 }, 40: { p10: 2800, p90: 4100 }, 42: { p10: 3000, p90: 4400 }, 50: { p10: 3100, p90: 4600 }
      },
      female: {
        22: { p10: 380, p90: 580 }, 24: { p10: 480, p90: 720 }, 26: { p10: 580, p90: 870 }, 28: { p10: 760, p90: 1140 },
        30: { p10: 950, p90: 1420 }, 32: { p10: 1250, p90: 1800 }, 34: { p10: 1600, p90: 2400 }, 36: { p10: 2000, p90: 3000 },
        38: { p10: 2400, p90: 3500 }, 40: { p10: 2700, p90: 3900 }, 42: { p10: 2900, p90: 4200 }, 50: { p10: 3000, p90: 4400 }
      }
    };

    function calculateWeightLoss() {
      const birthWeight = parseFloat(document.getElementById('birth-weight-wl').value);
      const currentWeight = parseFloat(document.getElementById('current-weight-wl').value);
      const result = document.getElementById('weight-loss-result');
      if (!birthWeight || !currentWeight || birthWeight <= 0 || currentWeight <= 0) {
        result.innerHTML = '<span style="color: #e63946;">Please enter valid weights.</span>';
        return;
      }
      const lossPercent = ((birthWeight - currentWeight) / birthWeight) * 100;
      const rounded = lossPercent.toFixed(1);
      let message = `Weight loss: <strong>${rounded}%</strong>`;
      if (lossPercent > 10) {
        message += ` <span style="color: #e76f51;">(Exceeds 10%)</span>`;
      }
      result.innerHTML = message;
    }

    function calculateFeedVolume() {
      const weight = parseFloat(document.getElementById('feed-weight').value);
      const kcal = parseFloat(document.getElementById('feed-kcal').value);
      const kcalPerMl = parseFloat(document.querySelector('input[name="feed-type"]:checked').value);
      const result = document.getElementById('feed-result');
      if (!weight || !kcal || weight <= 0 || kcal <= 0) {
        result.innerHTML = '<span style="color: #e63946;">Please enter valid weight and kcal/kg/day.</span>';
        return;
      }
      const totalDailyMl = (kcal * weight) / kcalPerMl;
      const perFeedMl = totalDailyMl / 8;
      result.innerHTML = `
        <strong>Feed Volume:</strong><br>
        Total daily: <strong>${totalDailyMl.toFixed(1)} ml</strong><br>
        Every 3 hours (8 feeds/day): <strong>${perFeedMl.toFixed(1)} ml</strong>
      `;
    }

    function openTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(tab => { tab.classList.remove('active'); });
      document.querySelectorAll('.tab-button').forEach(button => { button.classList.remove('active'); });
      document.getElementById(tabName).classList.add('active');
      document.querySelector(`.tab-button[onclick="openTab('${tabName}')"]`).classList.add('active');
      document.querySelectorAll('.form-group').forEach(group => { group.classList.remove('active'); });
      document.querySelectorAll(`#${tabName} .form-group`).forEach(group => { group.classList.add('active'); });
      if (tabName === 'fenton') {
        const sex = document.querySelector('input[name="sex"]:checked').value;
        document.getElementById('fenton-male').style.display = sex === 'male' ? 'block' : 'none';
        document.getElementById('fenton-female').style.display = sex === 'female' ? 'block' : 'none';
      }
    }

    function updateDosages() {
      const weight = parseFloat(document.getElementById('weight').value);
      const age = document.querySelector('input[name="age"]:checked').value;
      const table = document.getElementById('dosage-table');
      if (!weight || weight <= 0) {
        table.innerHTML = `<tr><td colspan="4">Please enter a valid weight.</td></tr>`;
        return;
      }
      let rows = '';
      drugData.forEach(drug => {
        drug.dose.forEach(dose => {
          let doseMg = (dose.mgPerKg * weight).toFixed(2);
          let interval = dose.interval[age];
          if (typeof interval === 'object') {
            if (interval["≤ 7 days"] || interval["> 7 days"]) {
              let ageInterval = interval[age];
              if (typeof ageInterval === 'object') {
                if (weight < 1.2) {
                  interval = ageInterval["< 1.2 kg"] || ageInterval["< 2 kg"];
                } else if (weight <= 2) {
                  interval = ageInterval["1.2–2 kg"] || ageInterval["< 2 kg"];
                } else {
                  interval = ageInterval["> 2 kg"];
                }
              } else {
                interval = ageInterval;
              }
            } else {
              if (weight < 1.2) {
                interval = interval["< 1.2 kg"] || interval["< 2 kg"];
              } else if (weight <= 2) {
                interval = interval["1.2–2 kg"] || interval["< 2 kg"];
              } else {
                interval = interval["> 2 kg"];
              }
            }
            if (drug.name === "Metronidazole" && age === "> 7 days" && weight > 2 && dose.mgPerKg === 15) {
              doseMg = (15 * weight).toFixed(2);
            }
          }
          if (!interval) return;
          rows += `
            <tr>
              <td><div class="cell-content">${drug.name}<div class="conc">(${dose.condition})</div></div></td>
              <td>${dose.mgPerKg}</td>
              <td>${doseMg}</td>
              <td>${interval}</td>
            </tr>
          `;
        });
      });
      table.innerHTML = rows || `<tr><td colspan="4">No matching data.</td></tr>`;
    }

    function updateFenton() {
      const weight = parseFloat(document.getElementById('fenton-weight').value) || 0;
      const sex = document.querySelector('input[name="sex"]:checked').value;
      const ga = parseFloat(document.getElementById('gestational-age').value) || 0;
      const resultDiv = document.getElementById('fenton-result');
      if (!weight || !ga) {
        resultDiv.innerHTML = 'Please enter both weight and gestational age.';
        return;
      }
      if (weight < 300 || weight > 6000 || ga < 22 || ga > 50) {
        resultDiv.innerHTML = 'Please enter valid weight (300–6000g) and gestational age (22–50 weeks).';
        return;
      }
      let gaClass;
      if (ga > 42) gaClass = 'Post Term (>42 weeks)';
      else if (ga >= 40) gaClass = 'Late Term (40 to <42 weeks)';
      else if (ga >= 37) gaClass = 'Term (≥37 weeks)';
      else if (ga >= 34) gaClass = 'Late Preterm (34 weeks to <37 weeks)';
      else if (ga >= 32) gaClass = 'Moderate Preterm (32 weeks to <34 weeks)';
      else gaClass = 'Very Preterm (<32 weeks)';

      let weightClass;
      if (weight > 4000) weightClass = 'Macrosomia (>4000g)';
      else if (weight < 1000) weightClass = 'Extremely Low Birth Weight (ELBW) (<1000g)';
      else if (weight < 1500) weightClass = 'Very Low Birth Weight (VLBW) (<1500g)';
      else if (weight < 2500) weightClass = 'Low Birth Weight (LBW) (<2500g)';
      else weightClass = 'Normal Weight';

      let sizeClass;
      const gaPoints = Object.keys(fentonPercentiles[sex]).map(Number).sort((a, b) => a - b);
      let closestGa = gaPoints.find(point => point >= ga) || gaPoints[gaPoints.length - 1];
      const percentiles = fentonPercentiles[sex][closestGa];
      if (weight < percentiles.p10) {
        sizeClass = 'SGA';
      } else if (weight > percentiles.p90) {
        sizeClass = 'LGA';
      } else {
        sizeClass = 'AGA';
      }

      document.getElementById('fenton-male').style.display = sex === 'male' ? 'block' : 'none';
      document.getElementById('fenton-female').style.display = sex === 'female' ? 'block' : 'none';

      resultDiv.innerHTML = `
        <strong>Gestational Age Classification:</strong> ${gaClass}<br>
        <strong>Birth Weight Classification:</strong> ${weightClass}<br>
        <strong>Size Classification:</strong> ${sizeClass}<br>
        <em>(Based on Fenton 2025 growth charts, 10th and 90th percentiles)</em>
      `;
    }

    function setupChart(chart) {
      const plot = chart.querySelector('.plot');
      const xLine = chart.querySelector('.crosshair-x');
      const yLine = chart.querySelector('.crosshair-y');
      const readout = chart.querySelector('.readout');
      const img = chart.querySelector('img');
      const ranges = {
        l: parseFloat(chart.dataset.l),
        t: parseFloat(chart.dataset.t),
        r: parseFloat(chart.dataset.r),
        b: parseFloat(chart.dataset.b),
        xMin: parseFloat(chart.dataset.xmin),
        xMax: parseFloat(chart.dataset.xmax),
        yMin: parseFloat(chart.dataset.ymin),
        yMax: parseFloat(chart.dataset.ymax)
      };
      const margins = { l: ranges.l / 100, t: ranges.t / 100, r: ranges.r / 100, b: ranges.b / 100 };

      function updatePlot() {
        const imgRect = img.getBoundingClientRect();
        const plotWidth = imgRect.width * (1 - margins.l - margins.r);
        const plotHeight = imgRect.height * (1 - margins.t - margins.b);
        plot.style.left = (margins.l * imgRect.width) + 'px';
        plot.style.top = (margins.t * imgRect.height) + 'px';
        plot.style.width = plotWidth + 'px';
        plot.style.height = plotHeight + 'px';
        xLine.style.top = (plotHeight / 2) + 'px';
        yLine.style.left = (plotWidth / 2) + 'px';
        updateReadout();
      }

      function updateReadout() {
        const rp = plot.getBoundingClientRect();
        const relX = parseFloat(yLine.style.left) || rp.width / 2;
        const relY = parseFloat(xLine.style.top) || rp.height / 2;
        const age = ranges.xMin + (relX / rp.width) * (ranges.xMax - ranges.xMin);
        const tsb = ranges.yMax - (relY / rp.height) * (ranges.yMax - ranges.yMin);
        const readoutText = `Age: ${age.toFixed(1)} h (${(age / 24).toFixed(2)} d) • TSB: ${tsb.toFixed(1)} mg/dL (${Math.round(tsb * 17.1)} µmol/L)`;
        readout.textContent = readoutText;
      }

      function setCrosshair(age, tsb) {
        const rp = plot.getBoundingClientRect();
        if (!isNaN(age)) {
          const relX = ((age - ranges.xMin) / (ranges.xMax - ranges.xMin)) * rp.width;
          yLine.style.left = Math.max(0, Math.min(rp.width, relX)) + 'px';
        }
        if (!isNaN(tsb)) {
          const relY = ((ranges.yMax - tsb) / (ranges.yMax - ranges.yMin)) * rp.height;
          xLine.style.top = Math.max(0, Math.min(rp.height, relY)) + 'px';
        }
        updateReadout();
      }

      function handleDrag(type, e) {
        e.preventDefault();
        const rp = plot.getBoundingClientRect();
        let isDragging = true;
        function move(e) {
          if (!isDragging) return;
          const touch = e.touches ? e.touches[0] : e;
          if (type === 'x') {
            let relY = touch.clientY - rp.top;
            relY = Math.max(0, Math.min(rp.height, relY));
            xLine.style.top = relY + 'px';
          } else {
            let relX = touch.clientX - rp.left;
            relX = Math.max(0, Math.min(rp.width, relX));
            yLine.style.left = relX + 'px';
          }
          updateReadout();
        }
        function stop() {
          isDragging = false;
          document.removeEventListener('pointermove', move);
          document.removeEventListener('pointerup', stop);
        }
        document.addEventListener('pointermove', move);
        document.addEventListener('pointerup', stop);
      }

      xLine.addEventListener('pointerdown', (e) => handleDrag('x', e));
      yLine.addEventListener('pointerdown', (e) => handleDrag('y', e));
      img.addEventListener('load', updatePlot);
      img.addEventListener('error', () => { readout.textContent = 'Error: Image failed to load'; });
      if (img.complete) updatePlot();
      window.addEventListener('resize', updatePlot);
      chart.setCrosshair = setCrosshair;
    }

    function setAllCrosshairs() {
      const age = parseFloat(document.getElementById('photo-age-input').value);
      const tsb = parseFloat(document.getElementById('photo-tsb-input').value);
      document.querySelectorAll('#phototherapy .chart').forEach(chart => {
        if (chart.setCrosshair) chart.setCrosshair(age, tsb);
      });
    }

    function initApp() {
      openTab('phototherapy');
      document.querySelectorAll('#phototherapy .form-group').forEach(group => { group.classList.add('active'); });
      const sex = document.querySelector('input[name="sex"]:checked').value;
      document.getElementById('fenton-male').style.display = sex === 'male' ? 'block' : 'none';
      document.getElementById('fenton-female').style.display = sex === 'female' ? 'block' : 'none';
      document.querySelectorAll('#phototherapy .chart').forEach(setupChart);
    }

    window.onload = function() {
      initApp();
      document.getElementById('weight').addEventListener('input', updateDosages);
      document.querySelectorAll('input[name="age"]').forEach(input => { input.addEventListener('change', updateDosages); });
      document.getElementById('fenton-weight').addEventListener('input', updateFenton);
      document.getElementById('gestational-age').addEventListener('input', updateFenton);
      document.querySelectorAll('input[name="sex"]').forEach(input => {
        input.addEventListener('change', function() {
          updateFenton();
          document.getElementById('fenton-male').style.display = this.value === 'male' ? 'block' : 'none';
          document.getElementById('fenton-female').style.display = this.value === 'female' ? 'block' : 'none';
        });
      });
    };
  </script>
</body>
</html>
